<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile-Optimized Invite Students Dialog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Styles for active/inactive tabs */
        .tab-btn.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Main Page Content -->
    <div class="min-h-screen w-full flex justify-center items-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-md text-center">
            <h1 class="text-2xl font-bold text-gray-800">My Awesome Lesson</h1>
            <p class="mt-2 text-gray-600">
                There are currently <span id="invited-count-main" class="font-bold text-indigo-600">3</span> students invited.
            </p>
            <button id="open-dialog-btn" class="mt-6 px-6 py-3 text-base font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Manage Invitations
            </button>
        </div>
    </div>

    <!-- Main Dialog Modal -->
    <div id="invite-dialog" class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto flex justify-center p-0 sm:p-4 z-50 hidden sm:items-center">
        <div class="bg-white rounded-none sm:rounded-xl shadow-2xl w-full min-h-full sm:min-h-0 sm:max-w-4xl lg:h-[90vh] flex flex-col lg:overflow-hidden">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800">Invite Students</h2>
                <button id="close-dialog-btn" class="p-1 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-800 transition-colors">
                    <i class="fa-solid fa-xmark fa-fw text-2xl"></i>
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="lg:flex-grow flex flex-col lg:flex-row lg:min-h-0">

                <!-- Mobile Tab Navigation -->
                <div class="lg:hidden border-b border-gray-200 flex-shrink-0">
                    <div class="flex">
                        <button id="tab-select" class="tab-btn flex-1 p-4 text-center text-sm font-medium text-gray-500 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 transition-colors active">
                            Select Students
                        </button>
                        <button id="tab-invited" class="tab-btn flex-1 p-4 text-center text-sm font-medium text-gray-500 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 transition-colors">
                            <span id="invited-tab-label">Participants (0)</span>
                        </button>
                    </div>
                </div>

                <!-- Left Panel / Select Tab Content -->
                <div id="panel-select" class="w-full lg:w-3/5 lg:border-r border-gray-200 flex flex-col lg:min-h-0">
                    <div class="p-4 border-b border-gray-200 flex-shrink-0">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-2 gap-2">
                            <p class="text-sm text-gray-600">Select classes or individual students.</p>
                            <a href="#" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex-shrink-0">
                                Manage My Classes
                            </a>
                        </div>
                        <input id="search-input" type="text" placeholder="Search for a class, student, or email..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div id="selection-list" class="p-4 space-y-4 custom-scrollbar lg:flex-grow lg:overflow-y-auto">
                        <!-- Class items will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Right Panel / Invited Tab Content -->
                <div id="panel-invited" class="w-full lg:w-2/5 flex-col lg:min-h-0 hidden lg:flex">
                    <div class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                        <h3 class="font-bold text-gray-800 flex items-center">
                            <i class="fa-solid fa-users fa-fw mr-2"></i>
                            <span id="invited-count-header">Participants (0)</span>
                        </h3>
                        <button id="clear-all-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 hidden">
                            Remove all
                        </button>
                    </div>
                    <div id="summary-list-container" class="p-4 custom-scrollbar lg:flex-grow lg:overflow-y-auto">
                         <!-- Summary items will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-3 border-t border-gray-200 bg-gray-50 space-y-2 flex-shrink-0">
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <input type="text" readonly value="https://lesson.link/aB3xY9" class="w-full px-3 py-2 text-sm text-gray-500 bg-gray-100 border border-gray-300 rounded-md">
                    <button id="copy-link-btn" class="w-full sm:w-auto sm:flex-shrink-0 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center justify-center">
                        <i class="fa-solid fa-copy fa-fw mr-2"></i>
                        <span id="copy-link-text">Copy Link</span>
                    </button>
                </div>
                <div class="flex flex-col sm:flex-row sm:justify-end sm:items-center gap-2">
                    <button id="cancel-btn" class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </button>
                    <button id="save-changes-btn" disabled class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 disabled:cursor-not-allowed">
                        <span id="save-changes-text">Save Changes (0)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Dialog -->
    <div id="confirm-send-dialog" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p class="text-gray-700 text-lg">Would you like to send invitation emails to the new participants?</p>
            <div class="mt-6 flex justify-center items-center gap-6">
                <button id="confirm-dont-send-btn" class="text-sm font-medium text-gray-600 hover:text-gray-900 hover:underline">
                    Don't Send
                </button>
                <button id="confirm-send-btn" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700">
                    Send
                </button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- MOCK DATA ---
        const mockClasses = [
            { id: 'class_1', name: 'Grade 10 - Period 3', students: [{ id: 'stu_101', name: 'Alice Johnson', email: 'alice.j@example.com', status: 'active' }, { id: 'stu_102', name: 'Ben Carter', email: 'b.carter@example.com', status: 'pending' }, { id: 'stu_103', name: 'Catherine Davis', email: 'cathy.d@example.com', status: 'active' }, { id: 'stu_104', name: 'David Evans', email: 'dave.e@example.com', status: 'pending' }] },
            { id: 'class_2', name: 'Creative Writing Club', students: [{ id: 'stu_201', name: 'Frankie Gomez', email: 'frank.g@example.com', status: 'active' }, { id: 'stu_101', name: 'Alice Johnson', email: 'alice.j@example.com', status: 'active' }, { id: 'stu_202', name: 'Grace Hernandez', email: 'grace.h@example.com', status: 'pending' }] },
            { id: 'class_3', name: 'Shakespeare Seminar', students: [{ id: 'stu_301', name: 'Ivy King', email: 'ivy.k@example.com', status: 'active' }, { id: 'stu_302', name: 'Jack Lee', email: 'jack.lee@example.com', status: 'active' }, { id: 'stu_303', name: 'Karen Miller', email: 'karen.m@example.com', status: 'pending' }, { id: 'stu_304', name: 'Leo Nelson', email: 'leo.n@example.com', status: 'active' }, { id: 'stu_305', name: 'Mia Ortiz', email: 'mia.o@example.com', status: 'pending' }] },
            { id: 'class_4', name: 'Journalism Club', students: [] },
        ];

        // --- STATE MANAGEMENT ---
        let initialInvitedStudentIds = new Set();
        let invitedStudentIds = new Set();
        let expandedClasses = new Set();
        let searchTerm = '';
        const allStudents = new Map(mockClasses.flatMap(c => c.students).map(s => [s.id, s]));

        // --- DOM ELEMENTS ---
        const dialog = document.getElementById('invite-dialog');
        const openDialogBtn = document.getElementById('open-dialog-btn');
        const closeDialogBtn = document.getElementById('close-dialog-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const searchInput = document.getElementById('search-input');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const saveChangesText = document.getElementById('save-changes-text');
        const invitedCountMain = document.getElementById('invited-count-main');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const copyLinkText = document.getElementById('copy-link-text');
        const confirmSendDialog = document.getElementById('confirm-send-dialog');
        const confirmSendBtn = document.getElementById('confirm-send-btn');
        const confirmDontSendBtn = document.getElementById('confirm-dont-send-btn');
        
        // Panels and Lists
        const panelSelect = document.getElementById('panel-select');
        const panelInvited = document.getElementById('panel-invited');
        const selectionList = document.getElementById('selection-list');
        const summaryListContainer = document.getElementById('summary-list-container');
        
        // Tabs and Labels
        const tabSelect = document.getElementById('tab-select');
        const tabInvited = document.getElementById('tab-invited');
        const invitedTabLabel = document.getElementById('invited-tab-label');
        const invitedCountHeader = document.getElementById('invited-count-header');

        // --- HELPER FUNCTIONS ---
        const areSetsEqual = (setA, setB) => {
            if (setA.size !== setB.size) return false;
            for (const item of setA) {
                if (!setB.has(item)) return false;
            }
            return true;
        };

        // --- RENDER FUNCTIONS ---

        const renderSelectionList = () => {
            const lowercasedFilter = searchTerm.toLowerCase();
            const filteredClasses = mockClasses.map(c => {
                const matchingStudents = c.students.filter(s =>
                    s.name.toLowerCase().includes(lowercasedFilter) ||
                    s.email.toLowerCase().includes(lowercasedFilter)
                );
                if (c.name.toLowerCase().includes(lowercasedFilter) || matchingStudents.length > 0) {
                    return { ...c, students: matchingStudents.length > 0 ? matchingStudents : c.students };
                }
                return null;
            }).filter(Boolean);
            
            if (searchTerm && !filteredClasses.every(c => expandedClasses.has(c.id))) {
                 filteredClasses.forEach(c => expandedClasses.add(c.id));
            }

            if (filteredClasses.length === 0) {
                selectionList.innerHTML = `<div class="text-center py-10 px-4"><p class="text-gray-600">No classes or students match your search.</p></div>`;
                return;
            }

            selectionList.innerHTML = filteredClasses.map(currentClass => {
                const studentIdsInClass = currentClass.students.map(s => s.id);
                const selectedInClass = studentIdsInClass.filter(id => invitedStudentIds.has(id)).length;
                const isExpanded = expandedClasses.has(currentClass.id);

                const studentListHTML = isExpanded ? `
                    <div class="pl-8 pr-4 pb-3 border-t border-gray-200">
                        <div class="mt-3 space-y-2">
                            ${currentClass.students.map(student => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="student-${student.id}" data-student-id="${student.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 student-checkbox" ${invitedStudentIds.has(student.id) ? 'checked' : ''}>
                                    <label for="student-${student.id}" class="ml-3 select-none flex-grow">
                                        <div>
                                            <span class="${student.status === 'pending' ? 'text-gray-500' : 'text-gray-800'}">
                                                ${student.name}
                                                ${student.status === 'pending' ? '<span class="ml-2 text-xs font-normal text-gray-400">(Pending Signup)</span>' : ''}
                                            </span>
                                            <span class="block text-xs text-gray-400">${student.email}</span>
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                let selectedCountIndicator = '';
                if (selectedInClass > 0) {
                    const isAllSelected = selectedInClass === currentClass.students.length;
                    const desktopText = isAllSelected ? 'All students' : `${selectedInClass} student${selectedInClass > 1 ? 's' : ''}`;
                    const mobileText = isAllSelected ? 'All' : selectedInClass;
                    
                    selectedCountIndicator = `
                        <span class="ml-2 text-xs font-semibold text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded-full flex-shrink-0">
                            <span class="hidden sm:inline">${desktopText}</span>
                            <span class="sm:hidden">${mobileText}</span>
                        </span>
                    `;
                }


                return `
                    <div class="bg-gray-50 rounded-lg" data-class-id="${currentClass.id}">
                        <div class="flex items-center p-3">
                            <div class="flex items-center flex-grow min-w-0">
                                <input type="checkbox" id="class-${currentClass.id}" data-class-id-checkbox="${currentClass.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 class-checkbox flex-shrink-0">
                                <label for="class-${currentClass.id}" class="ml-3 select-none truncate flex items-center">
                                    <span class="font-semibold text-gray-800">${currentClass.name}</span>
                                    <span class="ml-2 text-sm text-gray-500 flex-shrink-0">(${currentClass.students.length})</span>
                                    ${selectedCountIndicator}
                                </label>
                            </div>
                            ${currentClass.students.length > 0 ? `<button data-toggle-id="${currentClass.id}" class="ml-auto p-1 rounded-full hover:bg-gray-200 toggle-class-btn"><i class="fa-solid ${isExpanded ? 'fa-chevron-down' : 'fa-chevron-right'} fa-fw"></i></button>` : ''}
                        </div>
                        ${studentListHTML}
                    </div>
                `;
            }).join('');
            
            // Set checked and indeterminate state after rendering
            document.querySelectorAll('.class-checkbox').forEach(el => {
                 const classId = el.dataset.classIdCheckbox;
                 const currentClass = mockClasses.find(c => c.id === classId);
                 if (!currentClass) return;

                 const studentIdsInClass = currentClass.students.map(s => s.id);
                 const selectedInClass = studentIdsInClass.filter(id => invitedStudentIds.has(id)).length;
                 
                 const isFullySelected = currentClass.students.length > 0 && selectedInClass === currentClass.students.length;
                 const isPartiallySelected = selectedInClass > 0 && !isFullySelected;

                 el.checked = isFullySelected;
                 el.indeterminate = isPartiallySelected;
            });
        };

        const renderSummaryList = () => {
            const fullySelectedClasses = [];
            const individualStudents = [];
            const remainingSelectedIds = new Set(invitedStudentIds);

            for (const currentClass of mockClasses) {
                if (currentClass.students.length === 0) continue;
                const classStudentIds = currentClass.students.map(s => s.id);
                const isFullySelected = classStudentIds.every(id => invitedStudentIds.has(id));

                if (isFullySelected) {
                    fullySelectedClasses.push({ type: 'class', data: currentClass });
                    classStudentIds.forEach(id => remainingSelectedIds.delete(id));
                }
            }

            for (const studentId of remainingSelectedIds) {
                const student = allStudents.get(studentId);
                if (student) {
                    individualStudents.push({ type: 'student', data: student });
                }
            }

            fullySelectedClasses.sort((a, b) => a.data.name.localeCompare(b.data.name));
            individualStudents.sort((a, b) => a.data.name.localeCompare(b.data.name));
            
            const rightPanelItems = [...fullySelectedClasses, ...individualStudents];

            if (rightPanelItems.length === 0) {
                summaryListContainer.innerHTML = `
                    <div class="text-center text-gray-500 h-full flex flex-col justify-center items-center p-4">
                        <i class="fa-solid fa-users fa-fw text-4xl mb-2 text-gray-400"></i>
                        <p>No students have been invited yet.</p>
                        <p class="text-xs mt-1">Use the panel on the left to make selections.</p>
                    </div>`;
            } else {
                summaryListContainer.innerHTML = `<ul class="space-y-2">${rightPanelItems.map(item => {
                    if (item.type === 'class') {
                        const currentClass = item.data;
                        const isExpanded = expandedClasses.has(`summary-${currentClass.id}`);
                        return `
                            <li class="bg-gray-100 rounded-md overflow-hidden border border-gray-200">
                                <div class="flex items-center text-sm text-gray-800 p-2">
                                    <button data-summary-toggle-id="${currentClass.id}" class="p-1 rounded-full hover:bg-gray-200 summary-toggle-btn">
                                        <i class="fa-solid ${isExpanded ? 'fa-chevron-down' : 'fa-chevron-right'} fa-fw text-base"></i>
                                    </button>
                                    <div class="flex-grow ml-2">
                                        <span class="font-semibold">${currentClass.name}</span>
                                        <span class="block text-xs text-gray-500">${currentClass.students.length} students</span>
                                    </div>
                                    <button data-remove-class-id="${currentClass.id}" class="ml-2 p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 flex-shrink-0 remove-class-btn">
                                        <i class="fa-solid fa-xmark fa-fw text-base"></i>
                                    </button>
                                </div>
                                ${isExpanded ? `
                                <ul class="pl-8 pr-2 pb-2 space-y-1 border-t border-gray-200 pt-2">
                                    ${currentClass.students.map(student => `
                                        <li class="flex items-center text-sm text-gray-700 p-1 rounded-md">
                                            <i class="fa-solid ${student.status === 'active' ? 'fa-user' : 'fa-envelope'} fa-fw mr-2 text-gray-500 flex-shrink-0"></i>
                                            <div class="flex-grow"><span>${student.name}</span></div>
                                        </li>
                                    `).join('')}
                                </ul>` : ''}
                            </li>`;
                    }
                    if (item.type === 'student') {
                        const student = item.data;
                        return `
                            <li class="flex items-center text-sm text-gray-800 bg-gray-100 p-2 rounded-md">
                                <i class="fa-solid ${student.status === 'active' ? 'fa-user' : 'fa-envelope'} fa-fw mr-3 text-gray-500 flex-shrink-0"></i>
                                <div class="flex-grow">
                                    <span>${student.name}</span>
                                    <span class="block text-xs text-gray-500">${student.email}</span>
                                    ${student.status === 'pending' ? `<div class="mt-1"><span class="text-xs font-semibold text-gray-600 bg-gray-200 px-2 py-0.5 rounded-full">Pending Signup</span></div>` : ''}
                                </div>
                                <button data-remove-student-id="${student.id}" class="ml-2 p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 flex-shrink-0 remove-student-btn">
                                    <i class="fa-solid fa-xmark fa-fw text-base"></i>
                                </button>
                            </li>`;
                    }
                    return '';
                }).join('')}</ul>`;
            }
        };

        const updateUI = () => {
            const count = invitedStudentIds.size;
            const hasChanges = !areSetsEqual(initialInvitedStudentIds, invitedStudentIds);
            
            invitedCountHeader.textContent = `Participants (${count})`;
            invitedTabLabel.textContent = `Participants (${count})`;
            saveChangesText.textContent = `Save Changes (${count})`;
            invitedCountMain.textContent = count;
            
            clearAllBtn.classList.toggle('hidden', count === 0);
            saveChangesBtn.disabled = !hasChanges;

            renderSelectionList();
            renderSummaryList();
        };

        // --- EVENT HANDLERS ---
        
        const handleSelectionChange = (e) => {
            const classCheckbox = e.target.closest('.class-checkbox');
            if (classCheckbox) {
                const classId = classCheckbox.dataset.classIdCheckbox;
                const currentClass = mockClasses.find(c => c.id === classId);
                if (!currentClass) return;
                
                const studentIdsInClass = currentClass.students.map(s => s.id);
                const areAllSelected = studentIdsInClass.every(id => invitedStudentIds.has(id));

                if (areAllSelected) {
                    studentIdsInClass.forEach(id => invitedStudentIds.delete(id));
                } else {
                    studentIdsInClass.forEach(id => invitedStudentIds.add(id));
                }
                updateUI();
            }

            const studentCheckbox = e.target.closest('.student-checkbox');
            if (studentCheckbox) {
                const studentId = studentCheckbox.dataset.studentId;
                if (invitedStudentIds.has(studentId)) {
                    invitedStudentIds.delete(studentId);
                } else {
                    invitedStudentIds.add(studentId);
                }
                updateUI();
            }

            const toggleButton = e.target.closest('.toggle-class-btn');
            if (toggleButton) {
                const classId = toggleButton.dataset.toggleId;
                if (expandedClasses.has(classId)) {
                    expandedClasses.delete(classId);
                } else {
                    expandedClasses.add(classId);
                }
                renderSelectionList();
            }
        };
        
        const handleSummaryChange = (e) => {
            const removeClassBtn = e.target.closest('.remove-class-btn');
            if (removeClassBtn) {
                const classId = removeClassBtn.dataset.removeClassId;
                const currentClass = mockClasses.find(c => c.id === classId);
                if(currentClass) {
                    currentClass.students.forEach(s => invitedStudentIds.delete(s.id));
                    updateUI();
                }
            }

            const removeStudentBtn = e.target.closest('.remove-student-btn');
            if (removeStudentBtn) {
                const studentId = removeStudentBtn.dataset.removeStudentId;
                invitedStudentIds.delete(studentId);
                updateUI();
            }
            
            const summaryToggleBtn = e.target.closest('.summary-toggle-btn');
            if (summaryToggleBtn) {
                const classId = `summary-${summaryToggleBtn.dataset.summaryToggleId}`;
                if (expandedClasses.has(classId)) {
                    expandedClasses.delete(classId);
                } else {
                    expandedClasses.add(classId);
                }
                renderSummaryList();
            }
        };

        const switchTab = (tabName) => {
            if (tabName === 'select') {
                tabSelect.classList.add('active');
                tabInvited.classList.remove('active');
                panelSelect.classList.remove('hidden');
                panelInvited.classList.add('hidden');
            } else { // 'invited'
                tabSelect.classList.remove('active');
                tabInvited.classList.add('active');
                panelSelect.classList.add('hidden');
                panelInvited.classList.remove('hidden');
                panelInvited.classList.add('flex');
            }
        };

        const openDialog = () => {
            // Store the initial state when opening the dialog
            initialInvitedStudentIds = new Set(['stu_102', 'stu_303', 'stu_305']);
            invitedStudentIds = new Set(initialInvitedStudentIds);
            
            expandedClasses = new Set();
            searchTerm = '';
            searchInput.value = '';
            dialog.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            switchTab('select');
            updateUI();
        };

        const closeDialog = () => {
            dialog.classList.add('hidden');
            confirmSendDialog.classList.add('hidden');
            document.body.style.overflow = '';
        };
        
        const saveAndClose = (sendEmails = false) => {
            console.log("Saving student IDs:", Array.from(invitedStudentIds));
            alert(`Saved ${invitedStudentIds.size} student invitations.`);
            
            if(sendEmails) {
                 const newStudentIds = new Set([...invitedStudentIds].filter(id => !initialInvitedStudentIds.has(id)));
                 if (newStudentIds.size > 0) {
                    console.log("Sending emails to new students:", Array.from(newStudentIds).map(id => allStudents.get(id)));
                    alert(`Email invitations would be sent to ${newStudentIds.size} new student(s).`);
                 }
            }

            initialInvitedStudentIds = new Set(invitedStudentIds);
            updateUI();
            closeDialog();
        };

        // --- EVENT LISTENERS ---
        openDialogBtn.addEventListener('click', openDialog);
        closeDialogBtn.addEventListener('click', closeDialog);
        cancelBtn.addEventListener('click', closeDialog);
        
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderSelectionList();
        });

        selectionList.addEventListener('click', handleSelectionChange);
        summaryListContainer.addEventListener('click', handleSummaryChange);

        clearAllBtn.addEventListener('click', () => {
            invitedStudentIds.clear();
            updateUI();
        });

        saveChangesBtn.addEventListener('click', () => {
            if (saveChangesBtn.disabled) return;
            
            const newStudentIds = new Set([...invitedStudentIds].filter(id => !initialInvitedStudentIds.has(id)));

            if (newStudentIds.size > 0) {
                confirmSendDialog.classList.remove('hidden');
            } else {
                saveAndClose(false);
            }
        });
        
        confirmSendBtn.addEventListener('click', () => saveAndClose(true));
        confirmDontSendBtn.addEventListener('click', () => saveAndClose(false));
        
        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText("https://lesson.link/aB3xY9").then(() => {
                copyLinkText.textContent = 'Copied!';
                setTimeout(() => { copyLinkText.textContent = 'Copy Link'; }, 2000);
            });
        });

        tabSelect.addEventListener('click', () => switchTab('select'));
        tabInvited.addEventListener('click', () => switchTab('invited'));
        
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !dialog.classList.contains('hidden')) {
                closeDialog();
            }
        });

    });
    </script>
</body>
</html>
